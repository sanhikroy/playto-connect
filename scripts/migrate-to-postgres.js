// Scripts to help with migration from SQLite to PostgreSQL
// This script should be run after setting up the Vercel PostgreSQL database

const { exec } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('Starting migration to PostgreSQL...');

// Step 1: Backup the current schema and migrations
const backupDir = path.join(__dirname, '../backup');
if (!fs.existsSync(backupDir)) {
  fs.mkdirSync(backupDir);
  console.log('Created backup directory');
}

// Backup the current migration lock file
try {
  fs.copyFileSync(
    path.join(__dirname, '../prisma/migrations/migration_lock.toml'),
    path.join(backupDir, 'migration_lock.toml.bak')
  );
  console.log('Backed up migration lock file');
} catch (err) {
  console.error('Error backing up migration lock file', err);
}

// Step 2: Update migration lock file for PostgreSQL
const migrationLockContent = `# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "postgresql"
`;

try {
  fs.writeFileSync(
    path.join(__dirname, '../prisma/migrations/migration_lock.toml'),
    migrationLockContent
  );
  console.log('Updated migration lock file to use PostgreSQL');
} catch (err) {
  console.error('Error updating migration lock file', err);
}

// Step 3: Run the necessary Prisma commands
console.log('Running Prisma commands...');

// Execute Prisma generate to update Prisma client
exec('npx prisma generate', (error, stdout, stderr) => {
  if (error) {
    console.error(`Error generating Prisma client: ${error}`);
    return;
  }
  console.log(`Prisma generate output: ${stdout}`);
  
  // Run migrate deploy to apply migrations to the new PostgreSQL database
  console.log('Running prisma migrate deploy...');
  exec('npx prisma migrate deploy', (error, stdout, stderr) => {
    if (error) {
      console.error(`Error applying migrations: ${error}`);
      return;
    }
    console.log(`Migration completed: ${stdout}`);
    
    console.log('Migration to PostgreSQL completed successfully');
    console.log('Remember to update your environment variables in Vercel with:');
    console.log('- DATABASE_URL: Your PostgreSQL connection string');
    console.log('- DIRECT_URL: Your direct PostgreSQL connection string');
    console.log('- DATABASE_PROVIDER: "postgresql"');
  });
}); 